<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="iOS14剪切板探究，淘宝实现方法分析和实现Demo"><meta name="keywords" content="iOS"><meta name="author" content="y500"><meta name="copyright" content="y500"><title>iOS14剪切板探究，淘宝实现方法分析和实现Demo | study and record</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '4.2.0'
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">y500</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">12</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">study and record</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="post-info"><div id="post-title">iOS14剪切板探究，淘宝实现方法分析和实现Demo</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-09-27</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Objective-C/">Objective-C</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>随着iOS 14的发布，剪切板的滥用也被大家所知晓。只要是APP读取剪切板内容，系统都会在顶部弹出提醒，而且这个提醒不能够关闭。这样，大家在使用APP的过程中就能够看到哪些APP使用了剪切板。</p>
<p>正好我们自己的应用也使用了剪切板，升级了iOS 14之后弹的着实让人心烦。就想着怎么处理一下，翻了一下<code>UIPasteboard</code>的文档，发现相关的内容并不多。<br>读取<code>UIPasteboard</code>的<code>string</code>、<code>strings</code>、<code>URL</code>、<code>URLs</code>、<code>image</code>、<code>images</code>、<code>color</code>、<code>colors</code>的时候会触发系统提示。<br>使用<code>hasStrings</code>、<code>hasURLs</code>、<code>hasImages</code>、<code>hasColors</code>等方法的时候不会触发系统提示。<br>那么思路就是尽可能少的去调用会触发系统提示的方法，根据其他方法去判断确实需要读取的时候再去调用那些方法。<br>根据我们自己的情况，只有判断<code>hasStrings</code>为<code>YES</code>就去读取，又不能清剪切板，其实还是有点不尽人意，然后又看到这个属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(readonly, nonatomic) NSInteger changeCount;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The number of times the pasteboard’s contents have changed.</span><br><span class="line"></span><br><span class="line">Whenever the contents of a pasteboard changes—specifically, when pasteboard items are added, modified, or removed—UIPasteboard increments the value of this property. After it increments the change count, UIPasteboard posts the notifications named UIPasteboardChangedNotification (for additions and modifications) and UIPasteboardRemovedNotification (for removals). These notifications include (in the userInfo dictionary) the types of the pasteboard items added or removed. Because UIPasteboard waits until the end of the current event loop before incrementing the change count, notifications can be batched. The class also updates the change count when an app reactivates and another app has changed the pasteboard contents. When users restart a device, the change count is reset to zero.</span><br></pre></td></tr></table></figure>
<p>然后就又加了一个条件，记录一下真正读取剪切板时的<code>changeCount</code>，如果下次读取的时候没有发生变化则不读取。<br>这样一来效果就好多了，应用运行生命周期内，基本上只会弹出一次提示。</p>
<p>但是，后来看到淘宝更牛逼，命中了真正分享出来的内容才会弹，其他则不会弹。然后就研究了一下淘宝的分享内容和新的API文档，大概得到了答案。<br>先看下淘宝的分享内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">9👈幅治内容 Http:&#x2F;T$AJg8c4IfW3q$打開👉绹..寶👈【贵州茅台酒 茅台 飞天53度酱香型白酒收藏 500ml*1单瓶装送礼高度】</span><br></pre></td></tr></table></figure>
<p>组成部分：数字+文字+链接的形势，再结合iOS 14提供的新API：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">detectPatternsForPatterns:completionHandler:</span><br><span class="line">detectPatternsForPatterns:inItemSet:completionHandler:</span><br></pre></td></tr></table></figure>

<p>而<code>UIPasteboardDetectionPattern</code>系统只提供了三种：</p>
<ol>
<li>数字 <code>UIPasteboardDetectionPatternNumber</code></li>
<li>链接 <code>UIPasteboardDetectionPatternProbableWebURL</code></li>
<li>搜索<code>UIPasteboardDetectionPatternProbableWebSearch</code></li>
</ol>
<p>大胆猜测，淘宝应该是通过判断是否符合数字和链接的规则来判断是否命中分享内容。</p>
<p>然后就写了一个demo来验证，核心代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">UIPasteboard *board &#x3D; [UIPasteboard generalPasteboard];</span><br><span class="line">    </span><br><span class="line">[board detectPatternsForPatterns:[NSSet setWithObjects:UIPasteboardDetectionPatternProbableWebURL, UIPasteboardDetectionPatternNumber, UIPasteboardDetectionPatternProbableWebSearch, nil]</span><br><span class="line">                   completionHandler:^(NSSet&lt;UIPasteboardDetectionPattern&gt; * _Nullable set, NSError * _Nullable error) &#123;</span><br><span class="line">        </span><br><span class="line">        BOOL hasNumber &#x3D; NO, hasURL &#x3D; NO;</span><br><span class="line">        for (NSString *type in set) &#123;</span><br><span class="line">            if ([type isEqualToString:UIPasteboardDetectionPatternProbableWebURL]) &#123;</span><br><span class="line">                hasURL &#x3D; YES;</span><br><span class="line">            &#125; else if ([type isEqualToString:UIPasteboardDetectionPatternNumber]) &#123;</span><br><span class="line">                hasNumber &#x3D; YES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (hasNumber &amp;&amp; hasURL) &#123;</span><br><span class="line">            </span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                UIAlertController *alert &#x3D; [UIAlertController alertControllerWithTitle:@&quot;温馨提示&quot; message:[NSString stringWithFormat:@&quot;%@\n%@&quot;, [board string], @&quot;符合淘宝的读取标准&quot;] preferredStyle:UIAlertControllerStyleAlert];</span><br><span class="line">                UIAlertAction *cancelAction &#x3D; [UIAlertAction actionWithTitle:@&quot;确定&quot; style:UIAlertActionStyleCancel handler:nil];</span><br><span class="line">                [alert addAction:cancelAction];</span><br><span class="line">                [self presentViewController:alert animated:YES completion:nil];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>

<p>然后构造了一个看起来符合条件<code>1 http:/123abc</code>的串去反向验证了一下发现demo和淘宝的结果的表现是一致的，都弹了系统提示。</p>
<p>具体的demo可去<a href="https://github.com/y500/ios14_uipasteboard" target="_blank" rel="noopener">github</a>下载。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">y500</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.y500.me/2020/09/27/ios14_taobao_uipasteboard/">https://www.y500.me/2020/09/27/ios14_taobao_uipasteboard/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iOS/">iOS</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/09/29/image-not-render-on-ios14/"><i class="fa fa-chevron-left">  </i><span>iOS 14下面图片无法加载，包括weex、YYAnimateView、SDAnimatedImageView</span></a></div><div class="next-post pull-right"><a href="/2020/09/25/flutter-xcode12-ios14-crash/"><span>iOS14 debug安装的带有flutter应用从桌面图标重新启动时闪退</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '3ef65eeab5e4101c81a1',
  clientSecret: '29996fab52b58105a1331859f9a51c00e8586b8c',
  repo: 'https://github.com/zaiwentian/comment',
  owner: 'zaiwentian',
  admin: 'zaiwentian,y500',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By y500</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>